import{get_request_store as e,with_request_store as t}from"@sveltejs/kit/internal/server";import{parse as r}from"devalue";import{error as n,json as o}from"@sveltejs/kit";import{c as s,a,s as i,B as c}from"./chunks/shared.js";import{b as d,c as u,p}from"./chunks/environment.js";function f(t,r){if(!r)return e=>{void 0!==e&&n(400,"Bad Request")};if("unchecked"===t)return e=>e;if("~standard"in t)return async r=>{const{event:o,state:s}=e(),a=t["~standard"].validate,i=await a(r);return i.issues&&n(400,await s.handleValidationError({issues:i.issues,event:o})),i.value};throw new Error('Invalid validator passed to remote function. Expected "unchecked" or a Standard Schema (https://standardschema.dev)')}function m(e,t,r,n){const o=s(e,a(t,r.transport));return(r.remote_data??={})[o]??=n()}async function h(e,r,n,o,s,a){const i={...e,setHeaders:()=>{throw new Error("setHeaders is not allowed in remote functions")},cookies:{...e.cookies,set:(t,r,o)=>{if(!n)throw new Error("Cannot set cookies in `query` or `prerender` functions");if(o.path&&!o.path.startsWith("/"))throw new Error("Cookies set in remote functions must have an absolute path");return e.cookies.set(t,r,o)},delete:(t,r)=>{if(!n)throw new Error("Cannot delete cookies in `query` or `prerender` functions");if(r.path&&!r.path.startsWith("/"))throw new Error("Cookies deleted in remote functions must have an absolute path");return e.cookies.delete(t,r)}},route:{id:null},url:new URL(e.url.origin)},c=await t({event:i,state:r},()=>s(o));return t({event:i,state:r},()=>a(c))}function l(t,r){const n=r??t,o=f(t,r),s={type:"command",id:"",name:""},a=t=>{const{event:a,state:i}=e();if(!a.isRemoteRequest)throw new Error(`Cannot call a command (\`${s.name}(${r?"...":""})\`) during server-side rendering`);i.refreshes??={};const c=Promise.resolve(h(a,i,!0,t,o,n));return c.updates=()=>{throw new Error(`Cannot call '${s.name}(...).updates(...)' on the server`)},c};return Object.defineProperty(a,"__",{value:s}),Object.defineProperty(a,"pending",{get:()=>0}),a}function y(t){return function r(n){const o={method:"POST",onsubmit:()=>{}};Object.defineProperty(o,"enhance",{value:()=>({action:o.action,method:o.method,onsubmit:o.onsubmit})});const s={type:"submit",onclick:()=>{}};Object.defineProperty(s,"enhance",{value:()=>({type:"submit",formaction:o.buttonProps.formaction,onclick:()=>{}})}),Object.defineProperty(o,"buttonProps",{value:s});const a={type:"form",name:"",id:"",fn:async r=>{const{event:n,state:o}=e();o.refreshes??={};const s=await h(n,o,!0,r,e=>e,t);return n.isRemoteRequest||((o.remote_data??={})[a.id]=s),s}};return Object.defineProperty(o,"__",{value:a}),Object.defineProperty(o,"action",{get:()=>`?/remote=${a.id}`,enumerable:!0}),Object.defineProperty(s,"formaction",{get:()=>`?/remote=${a.id}`,enumerable:!0}),Object.defineProperty(o,"result",{get(){try{const{remote_data:t}=e().state;return t?.[a.id]}catch{return}}}),Object.defineProperty(o,"pending",{get:()=>0}),Object.defineProperty(s,"pending",{get:()=>0}),null==n&&Object.defineProperty(o,"for",{value:t=>{const{state:n}=e();let o=(n.form_instances??=new Map).get(t);return o||(o=r(t),o.__.id=`${a.id}/${encodeURIComponent(JSON.stringify(t))}`,o.__.name=a.name,n.form_instances.set(t,o)),o}}),o}()}function w(t,p,l){const y="function"==typeof p?p:void 0,w=l??(y?void 0:p),v=y??t,b=f(t,y),g={type:"prerender",id:"",name:"",has_arg:!!y,inputs:w?.inputs,dynamic:w?.dynamic},_=t=>{const p=(async()=>{const{event:p,state:f}=e(),l=a(t,f.transport),y=g.id,w=`${d}/${u}/remote/${y}${l?`/${l}`:""}`;if(!f.prerendering&&!c&&!p.isRemoteRequest)try{return await m(y,t,f,async()=>{const e=await fetch(new URL(w,p.url.origin).href);if(!e.ok)throw new Error("Prerendered response not found");const t=await e.json();return"error"===t.type&&n(t.status,t.error),(f.remote_data??={})[s(y,l)]=t.result,function(e,t){const n={};for(const r in t)n[r]=t[r].decode;return r(e,n)}(t.result,f.transport)})}catch{}if(f.prerendering?.remote_responses.has(w))return f.prerendering.remote_responses.get(w);const _=m(y,t,f,()=>h(p,f,!1,t,b,v));f.prerendering&&f.prerendering.remote_responses.set(w,_);const j=await _;if(f.prerendering){const e={type:"result",result:i(j,f.transport)};f.prerendering.dependencies.set(w,{body:JSON.stringify(e),response:o(e)})}return j})();return p.catch(()=>{}),p};return Object.defineProperty(_,"__",{value:g}),_}function v(t,r){const n=r??t,o=f(t,r),i={type:"query",id:"",name:""},c=t=>{if(p)throw new Error(`Cannot call query '${i.name}' while prerendering, as prerendered pages need static data. Use 'prerender' from $app/server instead`);const{event:r,state:c}=e(),d=m(i.id,t,c,()=>h(r,c,!1,t,o,n));return d.catch(()=>{}),d.refresh=async()=>{const{state:r}=e(),n=r.refreshes;if(!n)throw new Error(`Cannot call refresh on query '${i.name}' because it is not executed in the context of a command/form remote function`);n[s(i.id,a(t,r.transport))]=await d},d.withOverride=()=>{throw new Error(`Cannot call '${i.name}.withOverride()' on the server`)},d};return Object.defineProperty(c,"__",{value:i}),c}export{l as command,y as form,w as prerender,v as query};
